---
import { Image } from "astro:assets";
import { getLocalizedSettings } from "@/lib/localization-helpers";
import { translatePath, unlocalizedUrl } from "@/lib/localization-helpers";
import { defaultLocale, locales } from "site";

const currentLocale = Astro.currentLocale;

function getTranslatedUrl(locale: string): string {
	const unlocalizedPath = unlocalizedUrl(Astro.url.pathname);
	return translatePath(locale, unlocalizedPath);
}

function isActiveLocale(locale: string): boolean {
	return locale === currentLocale;
}

const { header, contacts } = getLocalizedSettings(currentLocale);

const logoPath = header.logo?.imagePath;

const images = import.meta.glob<{ default: ImageMetadata }>(
	"/src/assets/global/**/*.{webp,jpeg,jpg,png,gif,svg}",
);
---

<style>
	.menu-icon {
		position: relative;
		width: 50px;
		height: 50px;
		cursor: pointer;
	}
	.menu-icon .menu-icon__checkbox {
		display: block;
		width: 100%;
		height: 100%;
		position: relative;
		cursor: pointer;
		z-index: 2;
		-webkit-touch-callout: none;
		position: absolute;
		opacity: 0;
	}
	.menu-icon div {
		margin: auto;
		position: absolute;
		top: 0;
		right: 0;
		left: 0;
		bottom: 0;
		width: 22px;
		height: 12px;
	}
	.menu-icon span {
		position: absolute;
		display: block;
		width: 100%;
		height: 2px;
		background-color: var(--bar-bg, #000);
		border-radius: 5rem;
		transition: all 0.2s cubic-bezier(0.1, 0.82, 0.76, 0.965);
	}
	.menu-icon span:first-of-type {
		top: 0;
	}
	.menu-icon span:last-of-type {
		bottom: 0;
	}
	.menu-icon.active span:first-of-type,
	.menu-icon .menu-icon__checkbox:checked + div span:first-of-type {
		transform: rotate(45deg);
		top: 5px;
	}
	.menu-icon.active span:last-of-type,
	.menu-icon .menu-icon__checkbox:checked + div span:last-of-type {
		transform: rotate(-45deg);
		bottom: 5px;
	}
	.menu-icon.active:hover span:first-of-type,
	.menu-icon.active:hover span:last-of-type,
	.menu-icon:hover .menu-icon__checkbox:checked + div span:first-of-type,
	.menu-icon:hover .menu-icon__checkbox:checked + div span:last-of-type {
		width: 22px;
	}
	@media (min-width: 1024px) {
		.menu-icon:hover span:first-of-type {
			width: 26px;
		}
		.menu-icon:hover span:last-of-type {
			width: 12px;
		}
	}
	#navigation {
		pointer-events: none;
	}
	[data-nav-border-reveal] {
		--tw-border-opacity: 0;
	}
	.active-locale {
		font-weight: bolder;
	}
</style>

<style is:global>
	[data-nav-text-reveal] {
		opacity: 0;
	}
	[data-nav-text-reveal] > div {
		position: relative;
		margin: 0;
	}
	.split-parent {
		overflow: hidden;
	}
	.split-child {
		display: inline-block;
	}
</style>

<header class="fixed w-full z-30">
	<div class="items-center auto-cols-fr grid-cols-3 lg:grid-cols-3 grid-rows-[auto] justify-between left-0 py-3.5 px-6 lg:px-20 right-0 top-0 grid gap-4">
		<!-- Logo -->
		<div class="items-center justify-start relative flex text-blue-700 z-20">
			<a
				href={translatePath(currentLocale ?? defaultLocale, "/")}
				id="header-logo"
				class="text-blue-700 inline-block max-w-full"
			>
				<svg
					version="1.1"
					id="CompanyLogo"
					xmlns="http://www.w3.org/2000/svg"
					xmlns:xlink="http://www.w3.org/1999/xlink"
					x="0px"
					y="0px"
					viewBox="0 0 300 300"
					width={40}
					height={40}
					class="w-8 h-8 lg:w-10 lg:h-10"
					xml:space="preserve"
				>
					<style type="text/css">
						.st0 {
							clip-path: url(#PathR_00000030484139693231530050000007202149904154527160_);
							fill: none;
							stroke: #000000;
							stroke-width: 28;
							stroke-miterlimit: 10;
						}

						.st1 {
							clip-path: url(#PathL_00000111906239159643029990000008763162307303549323_);
							fill: none;
							stroke: #000000;
							stroke-width: 28;
							stroke-miterlimit: 10;
						}
					</style>
					<g>
						<defs>
							<path
								id="PathR"
								d="M286.4,71.8V233c0,3-0.2,6-0.8,8.9c-2.9,16.3-30.6,53.1-61.2,53.4c0,0-40,1.6-60.4-26.3
			c-0.3-0.5-0.3-1.1,0.1-1.5l12.7-12.7c0.5-0.5,1.2-0.4,1.6,0c2.7,2.9,16.5,21.7,40.9,20.2c33.6-2,45.2-34.9,45.2-43.8
			c0,0,0.8-172.4,0.1-175.2c-10-42-63.4-38.8-84.5-14.7l-59.6,60.1c-3,3-4.6,7.1-4.6,11.3c-0.1,1-0.2,2.1-0.2,3.1l-2.6,57.8
			c0,2.6,0.7,5,2.1,7.2c2.1,3.3,20.2,29.4,19.7,29.9c-3.8,3.8-8.5,8.5-12.2,12.2c-0.4,0.4-1.1,0.5-1.5,0.1
			c-3.6-3-15.9-18.9-25.6-38.4c-2.2-4.4-1.5-4.7-1.5-10.1l0.8-59c-0.8-19.3,3.4-22.9,15.9-35.6l51.1-51
			C178,16.3,183.5,1.1,234.8,5.8c22.2,2.1,38.7,17.3,47.5,32.4c2.7,4.7,4.1,10.1,4.1,15.5C286.4,60,286.4,67.3,286.4,71.8z"
							></path>
						</defs>
						<clipPath
							id="PathR_00000047739257205995265260000000317677073555739302_"
						>
							<use xlink:href="#PathR" style="overflow:visible;"
							></use>
						</clipPath>

						<path
							id="MaskR"
							style="clip-path:url(#PathR_00000047739257205995265260000000317677073555739302_);fill:none;stroke:#000000;stroke-width:28;stroke-miterlimit:10;"
							class="logo-path-mask"
							d="
		M132,218.3l-27-38.3v-77.1c0,0,50.7-57.2,60.4-67.4c9.7-10.2,42.1-22.5,52.3-23.4s31.3,5.1,38.3,12.1s17.9,1.1,20.6,42.7
		s0,163.9,0,163.9s-3.9,24.8-15.2,34.5c-11.3,9.7-22.7,20.3-33.4,19.8s-25.9-3.7-31.3-5.3c-5.4-1.6-28.6-22.1-28.6-22.1"
						></path>
					</g>
					<g>
						<defs>
							<path
								id="PathL"
								d="M13.6,228.2V67c0-3,0.2-6,0.8-8.9C17.2,41.7,45,5,75.6,4.7c0,0,40-1.6,60.4,26.3c0.3,0.5,0.3,1.1-0.1,1.5
			l-12.7,12.7c-0.5,0.5-1.2,0.4-1.6,0c-2.9-2.8-16.6-21.7-41-20.2C47,27,35.4,59.8,35.4,68.7c0,0-0.8,172.4-0.1,175.2
			c10,42,63.4,38.8,84.5,14.7l59.6-60.1c3-3,4.6-7.1,4.6-11.3c0.1-1,0.2-2.1,0.2-3.1l2.6-57.8c0-2.6-0.7-5-2.1-7.2
			c-2.1-3.3-20.2-29.4-19.7-29.9c3.8-3.8,8.5-8.5,12.2-12.2c0.4-0.4,1.1-0.5,1.5-0.1c3.6,3,15.9,18.9,25.6,38.4
			c2.2,4.4,1.5,4.7,1.5,10.1l-0.8,59c0.8,19.3-3.4,22.9-15.9,35.6L138,271c-15.9,12.6-21.5,27.9-72.8,23.1
			C43,292,26.5,276.8,17.7,261.7c-2.7-4.7-4.1-10.1-4.1-15.5C13.6,240,13.6,232.7,13.6,228.2z"
							></path>
						</defs>
						<clipPath
							id="PathL_00000141443442153955986570000000888460909890178439_"
						>
							<use xlink:href="#PathL" style="overflow:visible;"
							></use>
						</clipPath>

						<path
							id="MaskL"
							style="clip-path:url(#PathL_00000141443442153955986570000000888460909890178439_);fill:none;stroke:#000000;stroke-width:28;stroke-miterlimit:10;"
							class="logo-path-mask"
							d="
		M132,42c0,0-16.7-31.9-52.3-29.8S24.2,58.7,24.2,58.7v192c0,0,12.4,25.9,28.6,31.3c16.2,5.4,45.8,2.7,53.9,0s65.3-58.8,65.3-58.8
		l21.6-22.7l3.2-78.7L171,78.7"
						></path>
					</g>
				</svg>
			</a>
		</div>
		<!-- Holosense Logotype -->
		<div
			class="col-start-2 flex justify-center items-center h-full text-blue-700"
		>
			<a
				href={translatePath(currentLocale ?? defaultLocale, "/")}
				class="flex items-center justify-center hover:opacity-80 transition-opacity"
				id="holosense-logotype"
			>
				<svg
					width="200"
					height="37"
					viewBox="0 0 356 65"
					fill="none"
					xmlns="http://www.w3.org/2000/svg"
					class="w-32 h-6 lg:w-40 lg:h-8"
				>
					<path d="M0.189209 63.5V0.32373H5.56773V19.2766H23.8376C32.1473 19.2766 36.3021 23.4599 36.3021 31.8265V63.5H30.9236V30.9728C30.9236 26.3626 28.6185 24.0575 24.0084 24.0575H5.56773V63.5H0.189209Z" fill="currentColor"/>
					<path d="M45.0943 50.9501V31.8265C45.0943 23.4599 49.2776 19.2766 57.6441 19.2766H69.5964C77.9061 19.2766 82.0609 23.4599 82.0609 31.8265V50.9501C82.0609 59.3167 77.9061 63.5 69.5964 63.5H57.6441C49.2776 63.5 45.0943 59.3167 45.0943 50.9501ZM50.4728 51.8039C50.4728 56.4709 52.8063 58.8045 57.4734 58.8045H69.7672C74.3773 58.8045 76.6824 56.4709 76.6824 51.8039V30.9728C76.6824 26.3626 74.3773 24.0575 69.7672 24.0575H57.4734C52.8063 24.0575 50.4728 26.3626 50.4728 30.9728V51.8039Z" fill="currentColor"/>
					<path d="M90.857 52.6576V0.32373H96.2356V53.0845C96.2356 57.1824 98.313 59.3167 102.468 59.4875V64.183C94.7273 64.183 90.857 60.3412 90.857 52.6576Z" fill="currentColor"/>
					<path d="M107.173 50.9501V31.8265C107.173 23.4599 111.357 19.2766 119.723 19.2766H131.676C139.985 19.2766 144.14 23.4599 144.14 31.8265V50.9501C144.14 59.3167 139.985 63.5 131.676 63.5H119.723C111.357 63.5 107.173 59.3167 107.173 50.9501ZM112.552 51.8039C112.552 56.4709 114.885 58.8045 119.552 58.8045H131.846C136.456 58.8045 138.762 56.4709 138.762 51.8039V30.9728C138.762 26.3626 136.456 24.0575 131.846 24.0575H119.552C114.885 24.0575 112.552 26.3626 112.552 30.9728V51.8039Z" fill="currentColor"/>
					<path d="M151.485 61.2803V58.8045H171.291C175.845 58.8045 178.121 56.5279 178.121 51.9746C178.121 47.4214 176.3 44.8602 172.657 44.291L162.242 42.4982C155.07 41.3029 151.485 37.5181 151.485 31.1435C151.485 23.2322 155.697 19.2766 164.12 19.2766H178.548L181.451 21.4963V24.0575H163.779C159.168 24.0575 156.863 26.3057 156.863 30.802C156.863 34.7861 158.77 37.0912 162.583 37.7173L173.084 39.5101C180.028 40.6484 183.5 44.6894 183.5 51.6331C183.5 59.5444 179.288 63.5 170.865 63.5H154.387L151.485 61.2803Z" fill="currentColor"/>
					<path d="M190.846 50.9501V31.8265C190.846 23.4599 195.029 19.2766 203.396 19.2766H214.494C222.804 19.2766 226.959 23.4599 226.959 31.8265V43.5226H196.224V51.8039C196.224 56.4709 198.558 58.8045 203.225 58.8045H225.251V61.2803L222.349 63.5H203.396C195.029 63.5 190.846 59.3167 190.846 50.9501ZM196.224 38.9979H221.58V30.9728C221.58 26.3626 219.275 24.0575 214.665 24.0575H203.225C198.558 24.0575 196.224 26.3626 196.224 30.9728V38.9979Z" fill="currentColor"/>
					<path d="M236.116 63.5V19.2766H259.765C268.075 19.2766 272.229 23.4599 272.229 31.8265V63.5H266.851V30.9728C266.851 26.3626 264.546 24.0575 259.936 24.0575H241.495V63.5H236.116Z" fill="currentColor"/>
					<path d="M279.912 61.2803V58.8045H299.718C304.272 58.8045 306.548 56.5279 306.548 51.9746C306.548 47.4214 304.727 44.8602 301.084 44.291L290.669 42.4982C283.497 41.3029 279.912 37.5181 279.912 31.1435C279.912 23.2322 284.123 19.2766 292.547 19.2766H306.975L309.878 21.4963V24.0575H292.205C287.595 24.0575 285.29 26.3057 285.29 30.802C285.29 34.7861 287.197 37.0912 291.01 37.7173L301.511 39.5101C308.455 40.6484 311.927 44.6894 311.927 51.6331C311.927 59.5444 307.715 63.5 299.291 63.5H282.814L279.912 61.2803Z" fill="currentColor"/>
					<path d="M319.273 50.9501V31.8265C319.273 23.4599 323.456 19.2766 331.823 19.2766H342.921C351.231 19.2766 355.386 23.4599 355.386 31.8265V43.5226H324.651V51.8039C324.651 56.4709 326.985 58.8045 331.652 58.8045H353.678V61.2803L350.776 63.5H331.823C323.456 63.5 319.273 59.3167 319.273 50.9501ZM324.651 38.9979H350.007V30.9728C350.007 26.3626 347.702 24.0575 343.092 24.0575H331.652C326.985 24.0575 324.651 26.3626 324.651 30.9728V38.9979Z" fill="currentColor"/>
				</svg>
			</a>
		</div>
		<div class="justify-self-end col-span-1 row-span-1 z-40 col-start-3">
			<div
				class="items-center justify-between relative flex h-16 lg:w-32 lg:h-24"
			>
				<!-- Language switcher -->
				<!-- <div class="flex items-center gap-4">
					<a href={getTranslatedUrl("en")} class={`text-blue-700 text-sm ${isActiveLocale("en") ? "active-locale" : ""}`}>EN</a>
					<a href={getTranslatedUrl("ja")} class={`text-blue-700 text-sm ${isActiveLocale("ja") ? "active-locale" : ""}`}>JA</a>
				</div> -->
				<!-- Menu icon -->
				<div class="menu-icon">
					<input
						id="menu-toggle"
						class="menu-icon__checkbox"
						type="checkbox"
					/>
					<div>
						<span></span>
						<span></span>
					</div>
				</div>
			</div>
		</div>
	</div>
	<nav
		id="navigation"
		class="items-center bottom-0 text-sm font-medium justify-center left-0 fixed right-0 top-0 flex h-screen z-30"
	>
		<div
			id="navigation-background"
			class="bg-white w-full h-full absolute top-0 left-0 opacity-0"
		>
		</div>
		<div
			class="items-center font-semibold flex-wrap justify-center flex flex-col overflow-hidden z-20 w-full"
		>
			<div class="flex flex-col items-start md:items-center pt-10">
				{
					header.pages.map((page, index) => (
						<a
							data-nav-item
							href={translatePath(
								currentLocale ?? defaultLocale,
								page.link,
							)}
							class="items-center justify-start flex overflow-hidden gap-4 relative pr-10"
						>

							<div
								data-nav-text-reveal
								class="cursor-pointer overflow-hidden text-4xl xs:text-5xl md:text-[5.63rem] !leading-[1.15] text-black"
							>
								{page.title}
							</div>
						</a>
					))
				}
				<!-- This section is dynamically generated based on the locales available -->
				<!-- It displays language selection -->
				<!-- <div class="flex gap-8 pt-10 pl-16 md:pl-0">
					{
						locales.map((locale) => (
							<a
								href={getTranslatedUrl(locale)}
								class:list={[
									"items-center justify-start flex overflow-hidden gap-4 relative cursor-pointer",
									isActiveLocale(locale) && "active-locale",
								]}
							>
								<span
									data-nav-text-reveal
									class="overflow-hidden text-md xs:text-lg md:text-xl !leading-[1.15] text-black"
								>
									<span>{locale}</span>
								</span>
							</a>
						))
					}
				</div> -->
			</div>
		</div>
	</nav>
</header>

<script>
	import { gsap } from "gsap";
	import { ScrollTrigger } from "gsap/ScrollTrigger";
	// Uncomment if you have premium version of gsap
	// import { SplitText } from "gsap/SplitText";
	// import { DrawSVGPlugin } from "gsap/DrawSVGPlugin";
	import { BlurPlugin } from "@/utils/gsap-blur";
	import { LifecycleManager } from "@/utils/lifecycle-manager";

	gsap.registerPlugin(
		ScrollTrigger,
		/*SplitText, DrawSVGPlugin,*/
		BlurPlugin,
	);

	const lm = new LifecycleManager();

	lm.onElementLoaded("navigation", (ctx) => {
		ctx?.add(() => {
			gsap.timeline({
				defaults: {
					ease: "power1.inOut",
					stagger: 0.2,
				},
				scrollTrigger: {
					trigger: "body",
					start: "50px",
					toggleActions: "play none none reverse",
				},
			})
				.to("[data-company-name]", { opacity: 0 })
				.to("#holosense-logotype", { opacity: 0 }, "<")
				// .to("header .logo-path-mask", { drawSVG: 0 }, "<")
				.to("header .logo-path-mask", { opacity: 0 }, "<")
				.set("#header-logo", { pointerEvents: "none" });

			const tl = gsap.timeline({
				paused: true,
				defaults: {
					duration: 1,
					ease: "power3.out",
				},
			});

			// const childSplit = new SplitText("[data-nav-text-reveal]", {
			// 	type: "lines",
			// 	linesClass: "split-child",
			// });
			// const parentSplit = new SplitText("[data-nav-text-reveal]", {
			// 	// type: "lines",
			// 	linesClass: "split-parent",
			// });

			tl.set("#navigation", { pointerEvents: "auto" })
				.to("#navigation-background", { opacity: 1 }, "<")
				.to(
					"[data-nav-text-reveal]",
					{ opacity: 1, duration: 0.5, ease: "none" },
					"<=0.5",
				);
			// .from(
			// 	childSplit.lines,
			// 	{
			// 		duration: 1,
			// 		yPercent: 300,
			// 		skewY: 7,
			// 		stagger: 0.02,
			// 	},
			// 	"<",
			// );

			const menuItems = gsap.utils.toArray(
				"[data-nav-item]",
			) as HTMLElement[];

			menuItems.forEach((menuItem) => {
				const menuItemTl = gsap
					.timeline({
						defaults: { duration: 0.4, ease: "none" },
						paused: true,
					})
					.to(menuItem, {
						blur: 2,
					})
					.to(menuItem, {
						blur: 1,
					});
				menuItem.addEventListener("mouseenter", (e) =>
					menuItemTl.play(),
				);
				menuItem.addEventListener("mouseleave", (e) =>
					menuItemTl.pause(0),
				);
			});

			// Get the checkbox
			const menuToggle = document.getElementById("menu-toggle");

			// Add an event listener to the checkbox
			menuToggle?.addEventListener("change", function () {
				if ((this as HTMLInputElement).checked) {
					tl.play();
				} else {
					tl.reverse();
				}
			});
		});
	});
</script>
